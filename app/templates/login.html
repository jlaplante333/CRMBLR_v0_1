{% extends "base.html" %}

{% block body_class %}page-login{% endblock %}
{% block main_class %}container container--fluid{% endblock %}

{% block content %}
  <div class="split">
    <section class="pane split-left">
      <div class="pane-body">
        <div class="hero-section">
          <div class="hero-visual">crmblr</div>
          <h1 class="logo">crmblr</h1>
          <p class="tagline">
            Build <span class="highlight">conversational CRM workflows</span> 
            with a split-screen workspace and voice.
          </p>
        </div>
      </div>
    </section>
    <aside class="pane split-right">
      <div class="pane-header">Welcome back</div>
      <div class="pane-body">
        <p style="color: var(--gray-700); margin-bottom: 1.5rem;">Continue with Google or sign in with your email.</p>
        <div id="g_id_onload"
             data-client_id="{{ google_client_id }}"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="onGoogleCredential"
             data-itp_support="true">
        </div>
        <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin_with" data-shape="rect" data-logo_alignment="left"></div>

        <hr />

        <div>
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <button id="tab-signin" class="btn" type="button">Sign in</button>
            <button id="tab-signup" class="btn" type="button">Sign up</button>
          </div>
          <form id="form-signin" onsubmit="return false" style="display:block;">
            <input id="si-email" type="email" placeholder="Email" required />
            <input id="si-password" type="password" placeholder="Password" required />
            <button id="btn-signin" class="btn-primary" type="button">Sign in</button>
          </form>
          <form id="form-signup" onsubmit="return false" style="display:none;">
            <input id="su-name" type="text" placeholder="Name (optional)" />
            <input id="su-email" type="email" placeholder="Email" required />
            <input id="su-password" type="password" placeholder="Password" required />
            <button id="btn-signup" class="btn-primary" type="button">Create account</button>
          </form>
        </div>
      </div>
    </aside>
  </div>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    async function onGoogleCredential(resp){
      try {
        const r = await fetch('/auth/google', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credential: resp.credential })
        });
        if (!r.ok){ throw new Error('Auth failed'); }
        const data = await r.json();
        if (!data || !data.token){ throw new Error('No token returned'); }
        localStorage.setItem('crmb_lr_jwt', data.token);
        window.location.href = '/';
      } catch (e) {
        alert('Login failed: ' + (e.message || e));
      }
    }
    (function(){
      var tabSignin = document.getElementById('tab-signin');
      var tabSignup = document.getElementById('tab-signup');
      var formSignin = document.getElementById('form-signin');
      var formSignup = document.getElementById('form-signup');
      function show(which){
        formSignin.style.display = which === 'in' ? 'block' : 'none';
        formSignup.style.display = which === 'up' ? 'block' : 'none';
        if (which === 'in') {
          tabSignin.classList.add('active');
          tabSignup.classList.remove('active');
        } else {
          tabSignup.classList.add('active');
          tabSignin.classList.remove('active');
        }
      }
      tabSignin.addEventListener('click', function(){ show('in'); });
      tabSignup.addEventListener('click', function(){ show('up'); });
      // Set initial state
      tabSignin.classList.add('active');

      async function signin(){
        var email = document.getElementById('si-email').value.trim();
        var password = document.getElementById('si-password').value;
        const r = await fetch('/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
        const data = await r.json();
        if (!r.ok){ alert(data.error || 'Sign in failed'); return; }
        localStorage.setItem('crmb_lr_jwt', data.token);
        window.location.href = '/';
      }
      async function signup(){
        var email = document.getElementById('su-email').value.trim();
        var password = document.getElementById('su-password').value;
        var name = document.getElementById('su-name').value.trim();
        const r = await fetch('/auth/signup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password, name }) });
        const data = await r.json();
        if (!r.ok){ alert(data.error || 'Sign up failed'); return; }
        localStorage.setItem('crmb_lr_jwt', data.token);
        window.location.href = '/';
      }
      document.getElementById('btn-signin').addEventListener('click', signin);
      document.getElementById('btn-signup').addEventListener('click', signup);
    })();
  </script>
{% endblock %}
