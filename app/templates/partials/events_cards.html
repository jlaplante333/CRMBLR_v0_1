<div class="event-cards" style="display:flex; flex-direction:column; gap:10px">
  {% for e in events %}
  <div class="card card--tinted" id="event-{{ e.id }}" data-idx="{{ loop.index0 }}" data-tool="{{ e.tool or 'event' }}" style="border:1px solid var(--border); border-radius:8px; overflow:hidden">
    <div class="card-header" style="padding:6px 10px; display:flex; justify-content:space-between; align-items:center; background: var(--tint, #f9fafb)">
      <div style="display:flex; align-items:center; gap:8px">
        <div style="font-weight:600">{{ (e.tool | human_tool) if e.tool else 'Event' }}</div>
        {% if e.phase %}
          <span class="badge badge--secondary">{{ e.phase }}</span>
        {% endif %}
      </div>
      <div style="font-size:12px; color:var(--muted)">
        {{ e.ts | humants }}
      </div>
    </div>
    <div class="card-body" style="padding:8px 10px; display:flex; flex-direction:column; gap:6px">
      {% if e.phase == 'error' and e.error %}
        <div style="color:#b91c1c; font-weight:600">Error: {{ e.error }}</div>
      {% endif %}

      {% if e.tool in ['create_doc','update_doc','delete_doc'] and e.response and e.response.result %}
        <div>
          {{ e.tool }} {{ e.response.result }}
          {% if e.response._id %}
            • id: <code>{{ e.response._id }}</code>
          {% endif %}
          {% if e.response._index %}
            • index: <code>{{ e.response._index }}</code>
          {% endif %}
        </div>
      {% elif e.tool == 'list_docs' and e.response and e.response.hits %}
        {% set rows = e.response.hits.hits or [] %}
        {% if rows %}
          {% set first = rows[0]._source or {} %}
          {% set _keys = first.keys() | list %}
          <div style="overflow:auto">
            <table class="table" style="width:100%; border-collapse:collapse; font-size:12px">
              <thead>
                <tr>
                  {% for k in _keys %}
                    {% if loop.index0 < 5 %}
                      <th style="text-align:left; border-bottom:1px solid var(--border); padding:4px 6px">{{ k }}</th>
                    {% endif %}
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr>
                  {% for k in _keys %}
                    {% if loop.index0 < 5 %}
                      <td style="border-bottom:1px solid var(--border); padding:4px 6px">{{ r._source[k] }}</td>
                    {% endif %}
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div>Empty collection.</div>
        {% endif %}
      {% elif e.tool == 'list_collections' and e.response and e.response.collections is defined %}
        {% set cols = e.response.collections or [] %}
        {% if cols %}
          <div style="display:flex; flex-wrap: wrap; gap:6px">
            {% for c in cols %}
              <span class="badge badge--secondary">{{ c }}</span>
            {% endfor %}
          </div>
        {% else %}
          <div>No collections found.</div>
        {% endif %}
      {% endif %}

      <div style="display:flex; justify-content:flex-end; margin-top:6px">
        <button class="btn btn--ghost btn--sm" onclick="__toggleLogs({{ e.id }})" aria-controls="logs-{{ e.id }}" id="btn-logs-{{ e.id }}">Show logs</button>
      </div>
      <div id="logs-{{ e.id }}" style="display:none; margin-top:6px">
        <details>
          <summary style="cursor:pointer">Request</summary>
          <pre style="white-space:pre-wrap; font-size:12px; margin:6px 0 0">{{ e.request | tojson(indent=2) }}</pre>
        </details>
        {% if e.response %}
        <details>
          <summary style="cursor:pointer">Response</summary>
          <pre style="white-space:pre-wrap; font-size:12px; margin:6px 0 0">{{ e.response | tojson(indent=2) }}</pre>
        </details>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
  // Simple toggle for logs per-card; keeps details closed by default.
  (function(){
    // Persist open state across HTMX swaps
    window.__logOpen = window.__logOpen || Object.create(null);

    window.__toggleLogs = function(id){
      try {
        var el = document.getElementById('logs-' + id);
        var btn = document.getElementById('btn-logs-' + id);
        if (!el) return;
        var show = (el.style.display === 'none' || !el.style.display);
        el.style.display = show ? 'block' : 'none';
        if (btn) btn.textContent = show ? 'Hide logs' : 'Show logs';
        window.__logOpen[id] = show;
      } catch(_){ }
    }

    // Re-apply open state after HTMX replaces the cards container
    window.__rehydrateLogs = function(){
      try {
        var state = window.__logOpen || {};
        Object.keys(state).forEach(function(id){
          if (!state[id]) return;
          var el = document.getElementById('logs-' + id);
          var btn = document.getElementById('btn-logs-' + id);
          if (el){ el.style.display = 'block'; }
          if (btn){ btn.textContent = 'Hide logs'; }
        });
      } catch(_){ }
    }

    // Light random tint per card, stable by id
    function tintForCard(el){
      try {
        var tool = (el.getAttribute('data-tool') || 'event').toLowerCase();
        // Map tools to fixed hues
        var toolHue = {
          'list_collections': 210, // blue
          'list_docs': 235,        // indigo
          'search_docs': 190,      // cyan
          'create_doc': 140,       // green
          'get_doc': 270,          // violet
          'update_doc': 40,        // amber
          'delete_doc': 0,         // red
        };
        var h = (toolHue[tool] !== undefined) ? toolHue[tool] : 220; // default cool gray-blue
        var isDark = (document.documentElement.getAttribute('data-theme') === 'dark');
        var tint = isDark ? 'hsla(' + h + ', 70%, 35%, 0.18)' : 'hsl(' + h + ', 95%, 97%)';
        var border = isDark ? 'hsla(' + h + ', 80%, 60%, 0.5)' : 'hsl(' + h + ', 70%, 75%)';
        return { tint: tint, border: border };
      } catch(_){ return { tint: '', border: '' } }
    }
    function colorizeCards(){
      try {
        var cards = document.querySelectorAll('.card.card--tinted[id^="event-"]');
        cards.forEach(function(el){
          try {
            var t = tintForCard(el);
            if (t.tint) el.style.setProperty('--tint', t.tint);
            if (t.border) {
              el.style.setProperty('--tint-border', t.border);
              el.style.borderColor = t.border;
            }
          } catch(_){ }
        });
      } catch(_){ }
    }
    colorizeCards();
    // Re-apply on theme toggle
    var m = new MutationObserver(function(){ colorizeCards(); });
    m.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
  })();
</script>
