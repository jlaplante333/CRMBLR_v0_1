{% extends "base.html" %}

{% block body_class %}{% if not q %}page-home{% endif %}{% endblock %}

{% block content %}
  {% if not q %}
    <section class="hero" aria-label="CRMBLR search">
      <h1 class="logo">CRMBLR</h1>
      <form class="search-form hero-form search-box" action="/" method="get">
        <span class="search-box__icon" aria-hidden="true">
          <svg class="icon"><use href="/static/icons.svg#search"></use></svg>
        </span>
        <input
          type="search"
          name="q"
          placeholder="{{ placeholder_text }}"
          value=""
          autofocus
          aria-label="{{ placeholder_text }}"
          hx-get="/search"
          hx-target="#results"
          hx-trigger="input changed delay:250ms, search"
        />
        <span class="search-box__clear">
          <button id="btn-clear-home" class="btn btn--circle btn--ghost" type="button" aria-label="Clear search">
            <svg class="icon"><use href="/static/icons.svg#x"></use></svg>
          </button>
        </span>
      </form>
    </section>
  {% else %}
    <section class="search search--compact">
      <form class="search-form search-box" action="/" method="get">
        <span class="search-box__icon" aria-hidden="true">
          <svg class="icon"><use href="/static/icons.svg#search"></use></svg>
        </span>
        <input
          type="search"
          name="q"
          placeholder="{{ placeholder_text }}"
          value="{{ q }}"
          autofocus
          aria-label="{{ placeholder_text }}"
          hx-get="/search"
          hx-target="#results"
          hx-trigger="input changed delay:250ms, search"
        />
        <span class="search-box__clear">
          <button id="btn-clear-compact" class="btn btn--circle btn--ghost" type="button" aria-label="Clear search">
            <svg class="icon"><use href="/static/icons.svg#x"></use></svg>
          </button>
        </span>
      </form>
    </section>
  {% endif %}

  <section id="results" class="results" aria-live="polite">
    {% include "_results.html" with context %}
  </section>

  {% if not q and recent and recent|length > 0 %}
    <section class="recent">
      <h2 class="section-title">Recently added</h2>
      <ul class="result-list">
        {% for item in recent %}
          <li class="result-item">
            {% if item.image_url %}
              <img class="thumb" src="{{ item.image_url }}" alt="" />
            {% endif %}
            <div class="meta">
              <h3 class="title"><a href="{{ item.url or '#' }}" target="_blank" rel="noopener noreferrer">{{ item.title }}</a></h3>
              {% if item.category %}
                <div class="category">{{ item.category }}</div>
              {% endif %}
              {% if item.description %}
                <p class="desc">{{ item.description }}</p>
              {% endif %}
              {% if item.price is not none %}
                <div class="price">${{ '%.2f'|format(item.price) }}</div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}

<script>
  (function(){
    function wireClear(btnId, formSelector){
      var btn = document.getElementById(btnId);
      if (!btn) return;
      btn.addEventListener('click', function(){
        try {
          var form = btn.closest(formSelector) || document.querySelector(formSelector);
          var input = form && form.querySelector('input[name="q"]');
          if (!input) return;
          input.value = '';
          input.focus();
          var ev = new Event('input', { bubbles: true });
          input.dispatchEvent(ev);
        } catch(_){ }
      });
    }
    wireClear('btn-clear-home', '.search-form');
    wireClear('btn-clear-compact', '.search-form');
  })();
</script>
{% endblock %}
